<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nebulo UV Proxy</title>
  <script src="./uv.bundle.js"></script>
  <script src="./uv.config.js"></script>
  <style>
    :root {
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", system-ui, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, rgba(56, 175, 255, 0.2), transparent 45%),
        linear-gradient(180deg, #060810, #02030a 80%);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: stretch;
    }

    iframe {
      border: none;
      width: 100%;
      flex: 1;
      min-height: 0;
    }

    #status {
      position: absolute;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(2, 6, 20, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 999px;
      padding: 0.5rem 1.25rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      backdrop-filter: blur(18px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.65);
    }

    .loader {
      height: 0.9rem;
      width: 0.9rem;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-top-color: #5ce0ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .error {
      background: rgba(211, 75, 75, 0.85);
      border-color: rgba(211, 75, 75, 0.4);
    }
  </style>
</head>

<body>
  <div id="status">
    <span class="loader" aria-hidden="true"></span>
    <span id="statusText">Loading Nebulo UV proxy…</span>
  </div>
  <iframe sandbox="allow-scripts allow-same-origin allow-forms allow-popups" id="proxyFrame" allow="autoplay; clipboard-write; fullscreen"></iframe>

  <script>
    (function () {
      const frame = document.getElementById("proxyFrame");
      const statusText = document.getElementById("statusText");
      const statusEl = document.getElementById("status");
      const params = new URLSearchParams(window.location.search);
      const targetUrl = params.get("url");

      const showError = (message) => {
        statusText.textContent = message;
        statusEl.classList.add("error");
      };

      const loadProxy = () => {
        if (!targetUrl) {
          showError("No target URL provided to the proxy.");
          return;
        }

        if (!window.__uv$config || typeof __uv$config.encodeUrl !== "function") {
          showError("UV configuration failed to load.");
          console.error("UV proxy could not find __uv$config");
          return;
        }

        try {
          const encoded = __uv$config.encodeUrl(targetUrl);
          frame.src = `${__uv$config.prefix}${encoded}`;
          frame.addEventListener("load", () => {
            statusEl.style.opacity = "0";
            setTimeout(() => statusEl.remove(), 500);
          });
        } catch (error) {
          showError("Unable to encode the requested URL.");
          console.error("UV proxy encoding error", error);
        }
      };

      const registerServiceWorker = async () => {
        if (!("serviceWorker" in navigator)) {
          return;
        }

        try {
          const registration = await navigator.serviceWorker.register("./uv.sw.js");
          console.log("UV service worker registered:", registration.scope);
          await navigator.serviceWorker.ready;
        } catch (error) {
          console.warn("UV service worker registration failed:", error);
        }
      };

      registerServiceWorker().finally(loadProxy);
    })();
  </script>
</body>

</html>
